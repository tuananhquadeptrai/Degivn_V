name: Devign C Vulnerability Scan

on:
  push:
    paths:
      - 'Devign/C-Vul-Devign/**/*.c'
      - 'Devign/C-Vul-Devign/**/*.h'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: Devign/C-Vul-Devign

    steps:
      - name: Checkout repository with Git LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Check model files
        run: ls -lh models/*.pt || echo "No models found"

      - name: Run Devign vulnerability scan
        run: |
          set -e
          
          echo "## üîç C Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | File | Score | Confidence | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|-------|------------|---------|" >> $GITHUB_STEP_SUMMARY
          
          FILES=$(find . -name "*.c" -type f)
          
          if [ -z "$FILES" ]; then
            echo "No .c files found."
            echo "| ‚ÑπÔ∏è | No C files found | - | - | - |" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          FAILED=0
          
          for f in $FILES; do
            echo "================================================"
            echo "Scanning: $f"
            echo "================================================"
            
            result=$(python -m devign_pipeline.cli.analyze_file --file "$f" --json 2>&1) || true
            echo "$result"
            
            # Extract values from JSON
            score=$(echo "$result" | grep -oP '"score": \K[0-9.]+' | head -1 || echo "N/A")
            confidence=$(echo "$result" | grep -oP '"confidence": "\K[^"]+' || echo "N/A")
            
            if echo "$result" | grep -q '"vulnerable": true'; then
              echo ""
              echo "‚ùå VULNERABLE: $f"
              echo "   Score: $score"
              echo "   Confidence: $confidence"
              echo ""
              
              # Extract and display vulnerability highlights
              echo "üìç Vulnerability Locations:"
              echo "$result" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'highlights' in data:
        for h in data['highlights'][:5]:
            line = h.get('line', '?')
            snippet = h.get('code_snippet', '')
            norm_score = h.get('normalized_score', 0)
            print(f'   Line {line} (score: {norm_score:.2f}): {snippet}')
except:
    pass
"
              
              # Get vulnerability type based on code patterns
              vuln_types=""
              if echo "$result" | grep -qi "strcpy\|strcat\|sprintf\|gets"; then
                vuln_types="Buffer Overflow"
              fi
              if echo "$result" | grep -qi "printf.*user\|printf.*input"; then
                vuln_types="${vuln_types:+$vuln_types, }Format String"
              fi
              if echo "$result" | grep -qi "free.*return\|use_after_free"; then
                vuln_types="${vuln_types:+$vuln_types, }Use After Free"
              fi
              if echo "$result" | grep -qi "malloc.*null\|null.*deref"; then
                vuln_types="${vuln_types:+$vuln_types, }Null Pointer"
              fi
              [ -z "$vuln_types" ] && vuln_types="Potential Vulnerability"
              
              echo "| ‚ùå | \`$f\` | $score | $confidence | $vuln_types |" >> $GITHUB_STEP_SUMMARY
              
              # Add detailed highlights to summary
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>üîç Details for $f</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$result" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'highlights' in data:
        for h in data['highlights'][:5]:
            line = h.get('line', '?')
            snippet = h.get('code_snippet', '')
            norm_score = h.get('normalized_score', 0)
            print(f'Line {line} (risk: {norm_score:.0%}): {snippet}')
except:
    pass
" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              FAILED=1
            else
              echo "‚úÖ SAFE: $f (Score: $score)"
              echo "| ‚úÖ | \`$f\` | $score | $confidence | Clean |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED" -ne 0 ]; then
            echo "## ‚ö†Ô∏è Vulnerabilities Detected!" >> $GITHUB_STEP_SUMMARY
            echo "::error::One or more files contain potential vulnerabilities!"
            exit 1
          else
            echo "## ‚úÖ All Files Passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "Scan completed."
