name: C Vulnerability Scan

on:
  push:
    paths:
      - "**/*.c"
      - "**/*.h"
  pull_request:
    paths:
      - "**/*.c"
      - "**/*.h"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        working-directory: Devign/C-Vul-Devign
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check model files
        working-directory: Devign/C-Vul-Devign
        run: |
          echo "Checking model files..."
          ls -lh models/*.pt || echo "No model files found"

      - name: Scan C files
        working-directory: Devign/C-Vul-Devign
        run: |
          echo "## ðŸ” C Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          
          failed=0
          for file in $(find . -name "*.c" -type f); do
            echo "Analyzing: $file"
            result=$(python -m devign_pipeline.cli.analyze_file --file "$file" --json 2>&1) || true
            echo "Result: $result"
            
            if echo "$result" | grep -q '"vulnerable": true'; then
              echo "::error file=$file::VULNERABLE"
              failed=1
            else
              echo "::notice file=$file::Clean"
            fi
          done
          
          if [ "$failed" -ne 0 ]; then
            echo "::error::Vulnerable files detected!"
            exit 1
          fi
          
          echo "All files passed."
