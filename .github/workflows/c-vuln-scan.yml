name: C Vulnerability Scan

on:
  push:
    paths:
      - 'Devign/C-Vul-Devign/**/*.c'
      - 'Devign/C-Vul-Devign/**/*.h'
  pull_request:
    paths:
      - 'Devign/C-Vul-Devign/**/*.c'
      - 'Devign/C-Vul-Devign/**/*.h'
  workflow_dispatch:
    inputs:
      file:
        description: 'Optional C file path to scan (relative to Devign/C-Vul-Devign/)'
        required: false
        default: ''

defaults:
  run:
    working-directory: Devign/C-Vul-Devign

jobs:
  scan:
    name: Scan C files for vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'Devign/C-Vul-Devign/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify model files exist
        run: |
          echo "Checking model files..."
          for file in models/best_v2_seed42.pt models/vocab.json models/config.json; do
            if [ -f "$file" ]; then
              echo "‚úì Found: $file ($(du -h "$file" | cut -f1))"
            else
              echo "‚úó Missing: $file"
              exit 1
            fi
          done

      - name: Determine C files to scan
        id: files
        shell: bash
        run: |
          set -euo pipefail

          # Manual run with specific file
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.file }}" ]]; then
            echo "files=${{ github.event.inputs.file }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get changed files based on event type
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            echo "Unsupported event: ${{ github.event_name }}" >&2
            exit 1
          fi

          # Handle initial commit (no before SHA)
          if [[ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            CHANGED_FILES=$(git ls-files -- 'Devign/C-Vul-Devign/**/*.c' 'Devign/C-Vul-Devign/**/*.h' || true)
          else
            CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- 'Devign/C-Vul-Devign/**/*.c' 'Devign/C-Vul-Devign/**/*.h' || true)
          fi

          # Convert to relative paths (remove Devign/C-Vul-Devign/ prefix)
          if [[ -n "$CHANGED_FILES" ]]; then
            RELATIVE_FILES=$(echo "$CHANGED_FILES" | sed 's|^Devign/C-Vul-Devign/||')
            echo "Changed C files:"
            echo "$RELATIVE_FILES"
            FILES_LINE=$(echo "$RELATIVE_FILES" | tr '\n' ' ' | xargs)
            echo "files=$FILES_LINE" >> "$GITHUB_OUTPUT"
          else
            echo "No changed C files to scan."
            echo "files=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run vulnerability scan
        if: steps.files.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail

          FILES="${{ steps.files.outputs.files }}"
          echo "============================================"
          echo "üîç Scanning files: $FILES"
          echo "============================================"

          FAILED=0
          SCANNED=0
          VULNERABLE=0

          for file in $FILES; do
            if [[ ! -f "$file" ]]; then
              echo "::warning file=Devign/C-Vul-Devign/$file::File not found (may have been deleted)"
              continue
            fi

            echo ""
            echo "üìÑ Analyzing: $file"
            echo "--------------------------------------------"
            
            set +e
            python -m devign_pipeline.cli.analyze_file \
              --file "$file" \
              --github-annotations
            EXIT_CODE=$?
            set -e

            SCANNED=$((SCANNED + 1))

            case $EXIT_CODE in
              0)
                echo "‚úÖ $file is clean."
                ;;
              1)
                echo "‚ùå $file is VULNERABLE."
                VULNERABLE=$((VULNERABLE + 1))
                FAILED=1
                ;;
              2)
                echo "::error file=Devign/C-Vul-Devign/$file::Analyzer input error (exit 2) - check file path or type."
                ;;
              *)
                echo "::error file=Devign/C-Vul-Devign/$file::Analyzer crashed with exit code $EXIT_CODE."
                exit $EXIT_CODE
                ;;
            esac
          done

          echo ""
          echo "============================================"
          echo "üìä SCAN SUMMARY"
          echo "============================================"
          echo "Files scanned: $SCANNED"
          echo "Vulnerable:    $VULNERABLE"
          echo "Clean:         $((SCANNED - VULNERABLE))"
          echo "============================================"

          if [[ $FAILED -ne 0 ]]; then
            echo ""
            echo "‚ö†Ô∏è  One or more vulnerable files detected."
            echo "Please review the annotations above and fix the security issues."
            exit 1
          else
            echo ""
            echo "‚úÖ All scanned files are clean."
          fi

      - name: No C files changed
        if: steps.files.outputs.files == ''
        run: |
          echo "‚ÑπÔ∏è  No C/H files changed in this commit/PR."
          echo "Skipping vulnerability scan."
