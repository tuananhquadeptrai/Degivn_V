name: C Vulnerability Scan

on:
  push:
    paths:
      - "**/*.c"
      - "**/*.h"
  pull_request:
    paths:
      - "**/*.c"
      - "**/*.h"
  workflow_dispatch:
    inputs:
      file_path:
        description: "Path to C file to scan (optional)"
        required: false
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Devign/C-Vul-Devign

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('Devign/C-Vul-Devign/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure model files are present
        run: |
          mkdir -p models
          missing=0
          for model in models/best_v2_seed42.pt models/best_v2_seed1042.pt models/best_v2_seed2042.pt; do
            if [ ! -f "$model" ]; then
              echo "::warning::Model file $model is missing"
              missing=$((missing + 1))
            else
              echo "Found: $model ($(ls -lh $model | awk '{print $5}'))"
            fi
          done
          if [ "$missing" -eq 3 ]; then
            echo "::error::All model files are missing. Please add them via Git LFS."
            exit 1
          fi
          echo "Ensemble models ready: $((3 - missing))/3 available"

      - name: Determine files to scan
        id: files
        working-directory: ${{ github.workspace }}
        run: |
          if [ -n "${{ inputs.file_path }}" ]; then
            echo "files=${{ inputs.file_path }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find all C files in Devign/C-Vul-Devign directory
          files=$(find Devign/C-Vul-Devign -name "*.c" -o -name "*.h" | head -50)
          
          echo "Found C files:"
          echo "$files"
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run vulnerability scan
        if: steps.files.outputs.files != ''
        id: scan
        working-directory: ${{ github.workspace }}/Devign/C-Vul-Devign
        run: |
          echo "## ðŸ” C Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | File | Score | Confidence | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|-------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          failed=0
          vuln_count=0
          clean_count=0
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            # Convert path: Devign/C-Vul-Devign/xxx.c -> xxx.c
            relative_file="${file#Devign/C-Vul-Devign/}"
            
            [ ! -f "$relative_file" ] && continue
            
            echo "Analyzing: $relative_file"
            
            result=$(python -m devign_pipeline.cli.analyze_file --file "$relative_file" --json 2>&1) || true
            
            echo "Result: $result"
            
            if echo "$result" | grep -q '"vulnerable": true'; then
              vuln_count=$((vuln_count + 1))
              score=$(echo "$result" | grep -oP '"score": \K[0-9.]+' || echo "N/A")
              confidence=$(echo "$result" | grep -oP '"confidence": "\K[^"]+' || echo "N/A")
              
              echo "::error file=$file,line=1::VULNERABLE - Score: $score, Confidence: $confidence"
              echo "| âŒ | \`$relative_file\` | $score | $confidence | VULNERABLE |" >> $GITHUB_STEP_SUMMARY
              failed=1
            elif echo "$result" | grep -q '"vulnerable": false'; then
              clean_count=$((clean_count + 1))
              score=$(echo "$result" | grep -oP '"score": \K[0-9.]+' || echo "N/A")
              confidence=$(echo "$result" | grep -oP '"confidence": "\K[^"]+' || echo "N/A")
              
              echo "::notice file=$file,line=1::Clean - Score: $score, Confidence: $confidence"
              echo "| âœ… | \`$relative_file\` | $score | $confidence | Clean |" >> $GITHUB_STEP_SUMMARY
            else
              echo "::warning file=$file::Could not analyze file"
              echo "| âš ï¸ | \`$relative_file\` | - | - | Error |" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "${{ steps.files.outputs.files }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $vuln_count vulnerable, $clean_count clean" >> $GITHUB_STEP_SUMMARY
          
          if [ "$failed" -ne 0 ]; then
            echo "::error::$vuln_count file(s) detected as potentially vulnerable!"
            exit 1
          fi
          
          echo "All files passed vulnerability scan."
        shell: bash

      - name: No C files to scan
        if: steps.files.outputs.files == ''
        run: |
          echo "No C/H files found to scan."
          echo "## â„¹ï¸ No C files to scan" >> $GITHUB_STEP_SUMMARY
